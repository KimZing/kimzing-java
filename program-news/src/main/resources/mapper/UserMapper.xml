<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kimzing.news.repository.user.UserMapper">
    <sql id="all_column">id,deleted,creator,modifier,create_time,modify_time,username,avatar,position,score</sql>
    <sql id="po_column">username,avatar,position,score</sql>

    <insert id="insert" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
        INSERT INTO `user`(<include refid="po_column"></include>)
        VALUES(#{username},#{avatar},#{position},#{score});
    </insert>

    <insert id="insertBatch">
        INSERT INTO `user` (<include refid="po_column"></include>) VALUES
        <foreach item="item" collection="list" separator=",">
            (#{item.username},#{item.avatar},#{position},#{score})
        </foreach>
    </insert>
    <insert id="addFollow">
        INSERT INTO `r_user_like_author`(user_id, author_id) VALUES(#{userId}, #{authorId})
    </insert>

    <update id="update">
        UPDATE `user`
        <set>
            <if test="username != null">username = #{username},</if>
            <if test="avatar != null">avatar = #{avatar},</if>
            <if test="position != null">position = #{position},</if>
            <if test="score != null">score = #{score},</if>
        </set>
        WHERE id = #{id} AND deleted = 0;
    </update>

    <delete id="delete">
        UPDATE `user` SET deleted = 1 WHERE id = #{id}
    </delete>

    <delete id="removeFollow">
        DELETE FROM `r_user_like_author` WHERE user_id = #{userId} AND author_id = #{authorId}
    </delete>

    <resultMap id="selectUser" type="com.kimzing.news.domain.user.UserBO">
        <id column="id" property="id"></id>
        <association property="fansCount" column="id" select="com.kimzing.news.repository.user.UserMapper.countFansByAuthorId"></association>
        <association property="followCount" column="id" select="com.kimzing.news.repository.user.UserMapper.countFollowAuthorByUserId"></association>
    </resultMap>

    <select id="selectById" resultMap="selectUser">
        SELECT <include refid="all_column"></include> FROM `user` WHERE id = #{id} AND deleted = 0
    </select>

    <select id="selectPage" resultType="com.kimzing.news.domain.user.UserBO">
        SELECT <include refid="all_column"></include> FROM `user`
        <where>
            AND deleted = 0
            <if test="query != null">
                <if test="query.username != null">AND username = #{query.username}</if>
                <if test="query.avatar != null">AND avatar = #{query.avatar}</if>
                <if test="position != null">position = #{position},</if>
                <if test="score != null">score = #{score},</if>
            </if>
        </where>
    </select>

    <select id="countFollowByAuthorIdAndUserId" resultType="java.lang.Integer">
        select count(*) from `r_user_like_author`  where user_id = #{userId} and author_id = #{authorId}
    </select>

    <select id="countFansByAuthorId" resultType="java.lang.Integer">
        select count(*) from `r_user_like_author`  where author_id = #{authorId}
    </select>

    <select id="countFollowAuthorByUserId" resultType="java.lang.Integer">
        select count(*) from `r_user_like_author`  where user_id = #{userId}
    </select>


    <resultMap id="followAuthors" type="com.kimzing.news.domain.user.UserBO">
        <association property="fansCount" column="id" select="com.kimzing.news.repository.user.UserMapper.countFansByAuthorId"></association>
    </resultMap>

    <select id="getFollowAuthorList" resultMap="followAuthors"
            parameterType="java.lang.Integer">
        select
               au.id,min(au.username) as username,min(au.avatar) as avatar,min(au.position) as position,
               count(a.id) as articleCount
        from
             (select u.id, u.username, u.avatar, u.position
                 from r_user_like_author ru
                 LEFT JOIN user u ON  u.id = ru.author_id WHERE ru.user_id = #{userId}) as au
        LEFT JOIN article a
            ON au.id = a.author_id
        GROUP BY au.id
    </select>

</mapper>
